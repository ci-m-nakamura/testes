<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>samahikoGPT — WebLLM版</title>
<link rel="preconnect" href="https://esm.run">
<style>
  :root{
    --bg:#0b0f14; --panel:#111826; --panel2:#0e1522; --text:#e8eef7; --muted:#a5b4c3;
    --brand:#7c3aed; --brand2:#60a5fa; --border:#1a2436; --chip:#162034;
    --user:#18233c; --bot:#0d1728; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(900px 500px at 90% -10%, rgba(124,58,237,.18), transparent),
                               radial-gradient(800px 500px at -10% 30%, rgba(96,165,250,.10), transparent),
                               var(--bg);
       color:var(--text);font:14px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;}
  .wrap{min-height:100%;display:flex;flex-direction:column}
  header{position:sticky;top:0;z-index:5;backdrop-filter:blur(8px);
         background:linear-gradient(180deg, rgba(11,15,20,.85), rgba(11,15,20,.65)); border-bottom:1px solid var(--border)}
  .bar{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;gap:12px;align-items:center}
  .logo{width:36px;height:36px;border-radius:12px;background:conic-gradient(from 220deg, var(--brand), var(--brand2), #3b82f6, var(--brand));
        box-shadow:0 6px 24px rgba(124,58,237,.45)}
  .title{font-weight:800;letter-spacing:.2px}
  .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .chip{font-size:12px;color:var(--muted);background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px}

  main{flex:1;display:flex;justify-content:center}
  .grid{max-width:1100px; width:100%; display:grid; grid-template-columns: 1fr 320px; gap:16px; padding:18px}
  @media (max-width: 960px){ .grid{grid-template-columns:1fr} }

  .panel{background:linear-gradient(180deg, var(--panel), var(--panel2));
         border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .chat{display:flex;flex-direction:column;height:72vh;min-height:520px}
  .log{flex:1;overflow:auto;padding:16px}
  .msg{display:flex;gap:10px;margin:10px 0}
  .avatar{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--border)}
  .me .avatar{background:#17233b} .bot .avatar{background:#0f1a2d}
  .bubble{border:1px solid var(--border);border-radius:12px;padding:12px 14px;white-space:pre-wrap;word-break:break-word}
  .me .bubble{background:var(--user)} .bot .bubble{background:var(--bot)}
  .time{font-size:11px;color:var(--muted);margin-top:6px}

  .composer{display:grid;grid-template-columns:1fr auto;gap:10px;border-top:1px solid var(--border);padding:12px}
  textarea{min-height:56px;max-height:200px;resize:vertical;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px}
  .actions{display:flex;gap:8px}
  .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#1a2742,#0f1b31);
       color:var(--text);border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#21407c,#172e5e)}
  .btn.warn{border-color:#3b2d10;background:linear-gradient(180deg,#3b2d10,#241b09)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .side{display:flex;flex-direction:column;gap:12px;height:72vh;min-height:520px}
  .card{padding:14px}
  .h{font-size:13px;font-weight:800;color:#c9d7ee;margin-bottom:8px}
  .row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.06)}
  .row:last-child{border-bottom:none}
  .small{font-size:12px;color:var(--muted)}
  .err{color:var(--err)}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="bar">
    <div class="logo"></div>
    <div class="title">samahikoGPT — WebLLM</div>
    <div class="right">
      <span class="chip" id="model-chip">Model: 未選択</span>
      <span class="chip" id="status-chip">Status: 初期化中…</span>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="panel chat" aria-label="chat">
      <div class="log" id="log" role="log" aria-live="polite"></div>
      <div class="composer">
        <textarea id="input" placeholder="メッセージを入力（Shift+Enterで改行、Enterで送信）"></textarea>
        <div class="actions">
          <button class="btn" id="clear">履歴クリア</button>
          <button class="btn warn" id="stop">停止</button>
          <button class="btn primary" id="send">送信 ⏎</button>
        </div>
      </div>
    </section>

    <aside class="side">
      <div class="panel card">
        <div class="h">モデル選択（ブラウザ内推論）</div>
        <div class="row">
          <label for="model">モデル</label>
          <select id="model">
            <option value="Qwen2.5-0.5B-Instruct-q4f32_1-MLC">Qwen2.5-0.5B Instruct（推奨）</option>
            <option value="Llama-3.2-1B-Instruct-q4f16_1-MLC">Llama 3.2 1B Instruct（軽量）</option>
          </select>
        </div>
        <div class="row"><span>WebGPU</span><span class="small" id="gpu-stat">確認中…</span></div>
        <div class="row"><span>ダウンロード</span><span class="small" id="dl-stat">未開始</span></div>
        <div class="row"><span>キャッシュ</span><span class="small">IndexedDB（自動）</span></div>
        <div class="small" id="note"></div>
      </div>

      <div class="panel card">
        <div class="h">Tips</div>
        <div class="small">
          ・初回は数百MBのDLあり（以後キャッシュ）<br/>
          ・Chrome/Edge最新版＋HTTPSが安定<br/>
          ・重いと感じたらモデルを「Llama 1B」に
        </div>
      </div>
    </aside>
  </div>
</main>
</div>

<script type="module">
  // WebLLM（MLC）を利用したブラウザ内推論
  import { CreateWebWorkerMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

  const logEl = document.getElementById('log');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('send');
  const stopBtn = document.getElementById('stop');
  const clearBtn = document.getElementById('clear');
  const modelSel = document.getElementById('model');
  const gpuStat = document.getElementById('gpu-stat');
  const dlStat = document.getElementById('dl-stat');
  const modelChip = document.getElementById('model-chip');
  const statusChip = document.getElementById('status-chip');
  const note = document.getElementById('note');

  let engine = null;
  let abortController = null;
  let busy = false;
  const history = []; // {role, content}

  // 環境チェック（WebGPU）
  if (!('gpu' in navigator)) {
    gpuStat.textContent = "未対応（WebGPUが有効なChrome/Edgeを使用／HTTPS配信）";
    statusChip.textContent = "Status: WebGPU未対応";
    note.innerHTML = '<span class="err">この端末はWebGPU未対応です。</span><br>Chrome/Edge 最新版、または OS を更新してください。';
  } else {
    gpuStat.textContent = "OK";
  }

  function addMsg(role, text){
    const row = document.createElement('div');
    row.className = `msg ${role}`;
    row.innerHTML = `
      <div class="avatar">${role==='me'?'🧑':'🤖'}</div>
      <div>
        <div class="bubble">${escapeHtml(text)}</div>
        <div class="time">${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
      </div>`;
    logEl.appendChild(row);
    logEl.scrollTop = logEl.scrollHeight;
  }
  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;'}[m]))}
  function setBusy(v){
    busy = v;
    sendBtn.disabled = v;
    inputEl.disabled = v;
    stopBtn.disabled = !v;
    statusChip.textContent = v ? "Status: 生成中…" : "Status: 待機中";
  }

  async function initModel(modelId){
    // すでにロード済みなら破棄
    if (engine){ try{ await engine.unload(); }catch{} engine = null; }
    setBusy(true);
    modelChip.textContent = `Model: ${modelId}`;
    dlStat.textContent = "初期化中…";
    note.textContent = "初回はモデルをダウンロードしてブラウザに保存します。以後はキャッシュから高速起動します。";

    try{
      engine = await CreateWebWorkerMLCEngine(
        modelId,
        {
          // 進捗表示
          initProgressCallback: (info) => {
            if (info.text) dlStat.textContent = info.text;
          },
          // 低メモリ端末向けにKVキャッシュサイズを控えめに
          appConfig: {
            use_web_worker: true,
            temperature: 0.7,
            top_p: 0.95,
            max_gen_len: 256
          }
        }
      );
      statusChip.textContent = "Status: 待機中";
      addMsg('bot', `モデル **${modelId}** をロードしました。何でも聞いてください。`);
    }catch(e){
      console.error(e);
      statusChip.textContent = "Status: エラー";
      addMsg('bot', "モデルの読み込みに失敗しました。Chrome/Edgeの最新版・HTTPS配信・別モデルをお試しください。");
    }finally{
      setBusy(false);
    }
  }

  async function send(){
    const text = inputEl.value.trim();
    if (!text || busy || !engine) return;
    inputEl.value = "";
    addMsg('me', text);
    history.push({ role: "user", content: text });

    setBusy(true);
    abortController = new AbortController();

    const sys = "あなたは有能な日本語アシスタントです。簡潔に、必要に応じて箇条書きで答えてください。";
    const messages = [
      { role: "system", content: sys },
      ...history.map(m => ({ role: m.role === 'assistant' ? 'assistant' : 'user', content: m.content })),
    ];

    let acc = "";
    const botRow = document.createElement('div');
    botRow.className = 'msg bot';
    botRow.innerHTML = `<div class="avatar">🤖</div><div><div class="bubble" id="stream"></div><div class="time"></div></div>`;
    logEl.appendChild(botRow);
    const bubble = botRow.querySelector('#stream');

    try{
      // ストリーミング生成
      const stream = await engine.chat.completions.create({
        messages, stream: true
      }, { signal: abortController.signal });

      for await (const part of stream){
        const chunk = part.choices?.[0]?.delta?.content ?? "";
        if (chunk){
          acc += chunk;
          bubble.textContent = acc;
          logEl.scrollTop = logEl.scrollHeight;
        }
      }
      history.push({ role: "assistant", content: acc.trim() || "（応答なし）" });
    }catch(e){
      if (e.name === 'AbortError'){
        bubble.textContent += "\n\n（生成を停止しました）";
      } else {
        console.error(e);
        bubble.textContent = "エラーが発生しました。別の質問や、軽量モデルで再試行してください。";
      }
    }finally{
      setBusy(false);
    }
  }

  // 送受信ハンドラ
  sendBtn.addEventListener('click', send);
  inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
  stopBtn.addEventListener('click', ()=>{ if (abortController) abortController.abort(); });
  clearBtn.addEventListener('click', ()=>{ logEl.innerHTML=""; history.length=0; addMsg('bot',"新しいチャットを開始しました。"); });

  modelSel.addEventListener('change', ()=> initModel(modelSel.value));

  // 初期ロード
  (async ()=>{
    addMsg('bot', "初期化しています… モデル選択後、読み込みが始まります。");
    await initModel(modelSel.value);
  })();
</script>
</body>
</html>
